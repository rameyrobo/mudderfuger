import type { Metadata } from "next";
import { Anton } from 'next/font/google'
import "./globals.css";
import { SpeedInsights } from "@vercel/speed-insights/next"
import LazyStylesheetLoader from '../components/LazyStylesheetLoader';
import { Analytics } from "@vercel/analytics/next"
import Script from "next/script";
import { Partytown } from '@qwik.dev/partytown/react';


export const metadata: Metadata = {
  title: "Mudderfuger üõπüçª",
  description: "Generated by create next app",
};
const anton = Anton({ weight: '400', subsets: ['latin'] })

const ga4 = process.env.NEXT_PUBLIC_GA4 as string;

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en" className={anton.className}>
      <head>
        <link rel="icon" href="/icon.ico" type="image/x-icon" sizes="32x32" />
        <link rel="preconnect" href="https://mudderfuger.b-cdn.net" />

        <Partytown debug={false} forward={['dataLayer.push']} />

        <Script
          src={`https://www.googletagmanager.com/gtag/js?id=${ga4}`}
          type="text/partytown"
        />
        <Script
          id="ga4-init"
          type="text/partytown"
          dangerouslySetInnerHTML={{
            __html: `
              window.dataLayer = window.dataLayer || [];
              function gtag(){dataLayer.push(arguments);}
              gtag('js', new Date());
              gtag('config', '${ga4}', { page_path: window.location.pathname });
            `,
          }}
        />

        {/* Snipcart loader logic, lazyOnload, runs after DOM is interactive */}
        <Script id="snipcart-loader" strategy="lazyOnload">
          {`
            window.SnipcartSettings = {
              publicApiKey: "${process.env.NEXT_PUBLIC_SNIPCART_API_KEY}",
              loadStrategy: "on-user-interaction",
              loadCSS: false,
              modalStyle: "side",
              addProductBehavior: "none"
            };
            function loadSnipcart() {
              var c,d;(d=(c=window.SnipcartSettings).version)!=null||(c.version="3.0");
              if (window.__snipcartLoaded) return;
              window.__snipcartLoaded = true;
              var n = document.getElementById("snipcart");
              if (!n) {
                n = document.createElement("div");
                n.id = "snipcart";
                n.setAttribute("hidden", "true");
                document.body.appendChild(n);
              }
              var s = document.createElement("script");
              s.src = "https://cdn.snipcart.com/themes/v3.0/default/snipcart.js";
              s.async = true;
              document.head.appendChild(s);
            }
            var events = ["focus", "mouseover", "touchmove", "scroll", "keydown"];
            events.forEach(function(evt) {
              window.addEventListener(evt, loadSnipcart, { once: true });
            });
            setTimeout(loadSnipcart, 2750);
          `}
        </Script>
</head>
      <body>
        <LazyStylesheetLoader />
        {children}
        <SpeedInsights />
        <div
          hidden
          id="snipcart"
        ></div>
        <Analytics/>
      </body>
    </html>
  );
}